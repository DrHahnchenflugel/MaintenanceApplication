{# new_issue.html #}
{% extends "base.html" %}

{% block title %}Maintenance – New Issue{% endblock %}
{% block page_title %}New Issue{% endblock %}

{% block page_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/new_issue.css') }}">
{% endblock %}

{% block content %}

  {# Optional server-side error box #}
  {% if form_error %}
    <div class="card new-issue-error">
      <strong>Error:</strong> {{ form_error }}
    </div>
  {% endif %}

  <div class="new-issue-layout">

    {# Asset lock / selector #}
    <section class="card new-issue-asset">
      <div class="new-issue-asset__top">
        <div class="new-issue-asset__title">
          <h2 class="new-issue-h2">Asset</h2>
          {% if asset %}
            <p class="new-issue-asset__tag">
              <strong>{{ asset.asset_tag }}</strong>
              <span class="muted">
                {% if asset.site_shorthand %} · {{ asset.site_shorthand }}{% endif %}
                {% if asset.make and asset.model %} · {{ asset.make }} {{ asset.model }}{% endif %}
              </span>
            </p>
          {% else %}
            <p class="muted" style="margin:0;">No asset selected (required)</p>
          {% endif %}
        </div>

        <button type="button" class="btn btn-secondary new-issue-link" id="toggleAssetPicker">
          Not your robot?
        </button>
      </div>

      <div class="new-issue-asset__picker asset-picker"
        id="assetPicker"
        hidden
        data-assets-url="/maintenance/api/v2/assets"
        data-asset-statuses-url="/maintenance/api/v2/asset-statuses"
        data-makes-url="/maintenance/api/v2/assets/makes"
        data-models-url="/maintenance/api/v2/assets/models"
        data-variants-url="/maintenance/api/v2/assets/variants"
        data-asset-categories-url="/maintenance/api/v2/asset-categories">


        <div class="asset-picker__filters">
          <label class="asset-picker__field">
            <span class="asset-picker__label">Site</span>
            <select class="asset-picker__select" id="apSite">
              <option value="">All</option>
              {% for s in site_options|default([]) %}
                <option value="{{ s.id }}">{{ s.shorthand }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="asset-picker__field">
            <span class="asset-picker__label">Status</span>
            <select class="asset-picker__select" id="apStatus">
              <option value="">All</option>
              {% for st in asset_status_options|default([]) %}
                <option value="{{ st.id }}">{{ st.label }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="asset-picker__field">
            <span class="asset-picker__label">Category</span>
            <select class="asset-picker__select" id="apCategory">
              <option value="">All</option>
              {% for c in category_options|default([]) %}
                <option value="{{ c.id }}">{{ c.label }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="asset-picker__field">
            <span class="asset-picker__label">Make</span>
            <select class="asset-picker__select" id="apMake">
              <option value="">All</option>
              {% for m in make_options|default([]) %}
                <option value="{{ m.id }}">{{ m.label }}</option>
              {% endfor %}
            </select>
          </label>

          <label class="asset-picker__field">
            <span class="asset-picker__label">Model</span>
            <select class="asset-picker__select" id="apModel" disabled>
              <option value="">All</option>
            </select>
          </label>

          <label class="asset-picker__field">
            <span class="asset-picker__label">Variant</span>
            <select class="asset-picker__select" id="apVariant" disabled>
              <option value="">All</option>
            </select>
          </label>

          <div class="asset-picker__search">
            <label class="asset-picker__field asset-picker__field--search">
              <span class="asset-picker__label">Search</span>
              <input class="asset-picker__input" id="assetSearch" type="search"
                    placeholder="Asset tag, serial, or keywords (MIND-36)"
                    autocomplete="off">
            </label>

            <button type="button" class="btn asset-picker__btn" id="apApply">Apply</button>
            <button type="button" class="btn btn-secondary asset-picker__btn" id="apClear">Clear</button>
          </div>
        </div>

        <div class="asset-picker__results" id="apResults" aria-live="polite">
          <div class="asset-picker__empty muted">Use filters or search, then hit Apply.</div>
        </div>
      </div>
    </section>

    {# Form #}
    <form class="card new-issue-form"
          method="post"
          enctype="multipart/form-data"
          action="{{ url_for('app.create_issue_web') }}">

      <input type="hidden" name="asset_id" id="assetId"
       value="{{ request.form.get('asset_id', asset_id or '') }}">

      
      <div class="new-issue-grid">

        <div class="new-issue-field">
          <label class="new-issue-label" for="title">Issue Title</label>
          <input class="new-issue-input"
                 id="title"
                 name="title"
                 maxlength="50"
                 required
                 placeholder="Short + specific (max 50 chars)"
                 value="{{ request.form.get('title','') }}">
          <div class="new-issue-hint muted">Max 50 characters.</div>
        </div>

        <div class="new-issue-field new-issue-wide">
          <label class="new-issue-label" for="description">Issue Description<span class="muted">(optional)</span></label>
          <textarea class="new-issue-textarea"
                    id="description"
                    name="description"
                    rows="6"
                    placeholder="What happened? What did you try?">{{ request.form.get('description','') }}</textarea>
        </div>

        <div class="new-issue-field">
        <label class="new-issue-label" for="title">Reported by <span class="muted">(optional)</span></label>
        <input class="new-issue-input"
                id="created_by"
                name="created_by"
                placeholder="Name"
                value="{{ request.form.get('created_by','') }}">
      </div>
       

        <div class="new-issue-field new-issue-wide">
          <label class="new-issue-label" for="photo">Photo (optional)</label>
          <div class="new-issue-photo">
            <input class="new-issue-file"
                   id="photo"
                   name="photo"
                   type="file"
                   accept="image/*"
                   capture="environment">
            <div class="new-issue-hint muted">One photo is enough for most cases.</div>
          </div>
        </div>

      </div>

      <div class="new-issue-actions">
        <button class="btn btn--ok new-issue-submit" type="submit">Submit</button>
        <a class="btn btn-secondary" href="{{ url_for('app.issues_list') }}">Cancel</a>
      </div>

    </form>

  </div>
{% endblock %}

{% block page_js %}
  <script src="{{ url_for('static', filename='js/pages/new_issue/asset_picker.js') }}" defer></script>
{% endblock %}
