{% extends "base.html" %}
{% block title %} Maintenance - Issue {{ issue[0] }} {% endblock %}
{% block page_title %} Maintenance - Issue {{ issue[0] }} {% endblock %}


{% block content %}
  <div class="row" style="gap:16px; align-items:flex-start;">
    <!-- Left: Issue details -->
    <div class="card" style="flex:2;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Issue #{{ issue[0] }}</h2>
        <span class="badge">{{ issue[6] }}</span>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Description</label>
        <div class="pill" style="white-space:pre-wrap;">{{ issue[2] }}</div>
      </div>

      <div class="row" style="gap:12px; margin-top:12px;">
        <div class="field" style="flex:1;">
          <label>Opened</label>
          <div class="pill">{{ issue[3] }}</div>
        </div>

        {% if issue[6] != 'OPEN' %}
            <div class="field" style="flex:1;">
              <label>Closed</label>
              <div class="pill">{{ issue[4] if issue[4] else "—" }}</div>
            </div>
        {% endif %}
          </div>

        {% if issue[6] != 'OPEN' %}
          <div class="field" style="margin-top:12px;">
            <label>Close note</label>
            <div class="pill" style="white-space:pre-wrap;">{{ issue[5] if issue[5] else "—" }}</div>
          </div>
        {% endif %}
    </div>

    <!-- Right: Asset details -->
    <div class="card" style="flex:1;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Asset</h3>
        <span class="badge">{{ issue[16] }}</span>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Tag</label>
        <div class="pill">{{ issue[9] }}</div>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Make / Model / Variant</label>
        <div class="pill">{{ issue[11] }} {{ issue[12] }} {{ issue[13] }}</div>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Site</label>
        <div class="pill">{{ issue[26] }}</div>
      </div>

        {% if issue[16] %}
          <div class="row" style="gap:12px; margin-top:12px;">
            <div class="field" style="flex:1;">
              <label>Retired at</label>
              <div class="pill">{{ issue[14] if issue[14] else "—" }}</div>
            </div>
            <div class="field" style="flex:1;">
              <label>Retired reason</label>
              <div class="pill">{{ issue[15] if issue[15] else "—" }}</div>
            </div>
          </div>
        {% endif %}
    </div>
  </div>

  <!-- Attachments -->
  <div class="card" style="margin-top:16px;">
      <h3 style="margin:0 0 8px 0;">Attachments</h3>

      {% if not issue[20] %}
        <div class="pill">No attachments.</div>
      {% else %}
        {% set att_url = url_for('app.serve_attachment', subpath=issue[20]) %}
        {% if issue[22] and issue[22].startswith('image/') %}
          <a href="{{ att_url }}" target="_blank" rel="noopener">
            <img src="{{ att_url }}" alt="Attachment"
                 style="width:220px; height:160px; object-fit:cover; border-radius:8px;">
          </a>
        {% else %}
          <a class="btn" href="{{ att_url }}" target="_blank" rel="noopener">Download attachment</a>
        {% endif %}
      {% endif %}
  </div>

  <!-- Work Log -->
  <div class="table">
      <div class="thead--three">
        <div>Timestamp</div>
        <div>Action Taken</div>
        <div>Result</div>
      </div>


      {% for entry in work_logs %}
        <div class="trow--three">
            <div>{{ entry[4] }}</div>
            <div>{{ entry[3] }}</div>
            <div>{{ entry[2] }}</div>
        </div>
      {% endfor %}
      {% else %}
        <div class="trow--three">
            <div>-</div>
            <div>-</div>
            <div>-</div>
        </div>
      {% endelse %}

  </div>

  <!-- Actions -->
  <div class="row" style="gap:8px; margin-top:16px;">
    <a class="btn" href="{{ url_for('app.issues_active') }}">Back to Issues</a>
    <a class="btn" href="{{ url_for('app.issues_active') }}">Update/Resolve Issue</a>
  </div>
{% endblock %}