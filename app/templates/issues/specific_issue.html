{% block content %}

  {% if form_error %}
    <div class="card" style="border-left:4px solid #c0392b;margin-bottom:12px;">
      <strong>Error:</strong> {{ form_error }}
    </div>
  {% endif %}

  <div class="issue-layout">

    {# Top-left: Issue card #}
    <div class="card issue-main">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 style="margin:0;">{{ issue.title }}</h2>

        {% set code = issue.status.code %}
        <span class="badge badge--{{
              'ok'   if code == 'OPEN'
         else 'warn' if code == 'IN_PROGRESS'
         else 'bad'  if code == 'BLOCKED'
         else 'blue'
        }}">
          {{ issue.status.label }}
        </span>
      </div>

      <div class="field" style="margin-top:12px;">
        <label style="font-weight:bold;">Description</label>
        <div class="pill" style="white-space:pre-wrap;">
          {{ issue.description }}
        </div>
      </div>

      <div class="row" style="gap:12px;margin-top:12px;">
        <div class="field" style="flex:1;">
          <label style="font-weight:bold;">Reported by</label>
          <div class="pill">{{ issue.reported_by or "—" }}</div>
        </div>

        <div class="field" style="flex:1;">
          <label style="font-weight:bold;">Opened</label>
          <div class="pill">{{ issue.created_at }}</div>
        </div>
      </div>

      <div class="row" style="gap:12px;margin-top:12px;">
        <div class="field" style="flex:1;">
          <label style="font-weight:bold;">Last update</label>
          <div class="pill">{{ issue.last_action_at or "—" }}</div>
        </div>

        <div class="field" style="flex:1;">
          <label style="font-weight:bold;">Closed</label>
          <div class="pill">{{ issue.closed_at or "—" }}</div>
        </div>
      </div>
    </div>

    {# Top-middle: big image box #}
    <div class="card issue-image">
      <h3 style="margin-top:0;">Photos</h3>
      <div class="image-placeholder image-placeholder--large">
        IMAGE GOES HERE
      </div>
    </div>

    {# Top-right: Asset info (+ generic image) #}
    <div class="card asset-main">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0;">Asset</h3>
      </div>

      <div class="field" style="margin-top:12px;">
        <label style="font-weight:bold;">Tag</label>
        <div class="pill">{{ issue.asset.asset_tag }}</div>
      </div>

      <div class="field" style="margin-top:12px;">
        <label style="font-weight:bold;">Site ID</label>
        <div class="pill">{{ issue.asset.site_id or "—" }}</div>
      </div>

      {# slot for generic make/model image #}
      <div class="image-placeholder image-placeholder--small">
        GENERIC IMAGE FOR THIS MAKE / MODEL / VARIANT
      </div>
    </div>

    {# Bottom-left: Actions table #}
    <div class="card actions-card">
      <h3 style="margin-top:0;">Actions</h3>

      <div class="table table--scrollable">
        <div class="thead--three">
          <div>When</div>
          <div>Type</div>
          <div>Details</div>
        </div>

        {% if issue.actions %}
          {% for a in issue.actions %}
            <div class="trow--three">
              <div>{{ a.created_at }}</div>
              <div>{{ a.type.label }}</div>
              <div>
                <div style="white-space:pre-wrap;">{{ a.body }}</div>
                <div class="muted">by {{ a.created_by.name }}</div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="trow--three">
            <div>-</div><div>-</div><div>No actions yet.</div>
          </div>
        {% endif %}
      </div>
    </div>

    {# Bottom-right: Status changes table #}
    <div class="card status-card">
      <h3 style="margin-top:0;">Status Changes</h3>

      <div class="table table--scrollable">
        <div class="thead--four">
          <div>When</div>
          <div>From</div>
          <div>To</div>
          <div>By</div>
        </div>

        {% if issue.status_history %}
          {% for h in issue.status_history %}
            <div class="trow--four">
              <div>{{ h.changed_at }}</div>
              <div>{{ h.from_status.label if h.from_status else "—" }}</div>
              <div>{{ h.to_status.label }}</div>
              <div>{{ h.changed_by or "—" }}</div>
            </div>
          {% endfor %}
        {% else %}
          <div class="trow--four">
            <div>-</div><div>-</div><div>-</div><div>-</div>
          </div>
        {% endif %}
      </div>
    </div>

  </div> {# end .issue-layout #}

  {# Full-width: Add update form #}
  <div class="card" style="margin-top:16px;">
    <h3 style="margin-top:0;">Add update</h3>

    <form method="post" action="{{ url_for('app.add_issue_action', issue_id=issue.id) }}"
          class="row" style="gap:12px;flex-wrap:wrap;">

      <div class="field" style="flex:1;min-width:180px;">
        <label style="font-weight:bold;">Action type</label>
        <select name="action_type_code" required>
          {% for at in action_types %}
            <option value="{{ at.code }}">{{ at.label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="field" style="flex:1;min-width:180px;">
        <label style="font-weight:bold;">New status (optional)</label>
        <select name="new_status_id">
          <option value="">(no status change)</option>
          {% for st in status_options %}
            <option value="{{ st.id }}">{{ st.label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="field" style="flex:1;min-width:180px;">
        <label style="font-weight:bold;">Created by</label>
        <input type="text" name="created_by" placeholder="Your name or initials">
      </div>

      <div class="field" style="flex-basis:100%;margin-top:12px;">
        <label style="font-weight:bold;">Details</label>
        <textarea name="body" rows="3" required
                  placeholder="What did you do / what happened?"
                  style="width:100%;"></textarea>
      </div>

      <div style="flex-basis:100%;margin-top:8px;">
        <button type="submit" class="btn btn--ok">Save update</button>
        <a class="btn" href="{{ url_for('app.issues_list') }}">Back to list</a>
      </div>
    </form>
  </div>

{% endblock %}
