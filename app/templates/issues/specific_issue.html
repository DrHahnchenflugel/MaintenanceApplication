{% extends "base.html" %}

{% block title %}Maintenance – Issue{% endblock %}
{% block page_title %}Issue{% endblock %}

{% block page_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/issue.css') }}">
{% endblock %}

{% block content %}
  {% if form_error %}
    <div class="card issue-error">
      <strong>Error:</strong> {{ form_error }}
    </div>
  {% endif %}

  <div class="issue-layout">

    {# ─────────────────────────────
       A/B/C: Issue card
       ───────────────────────────── #}
    <div class="card issue-main">
      {% set code = issue.status.code if issue.status else 'UNKNOWN' %}

      {# A: title + status #}
      <div class="issue-main-header">
        <h2 class="issue-title">{{ issue.title }}</h2>
        <span class="issue-status status-{{ code|lower|replace('_','-') }}">
          {{ issue.status.label if issue.status else 'Unknown' }}
        </span>
      </div>

      {# B: description + meta (scrolls) #}
      <div class="issue-main-body">
        <div class="field issue-block">
          <label class="issue-label">Description (Click for more)</label>

          {# preview: clamped + clickable #}
          <button
            type="button"
            class="issue-desc-preview"
            onclick="openTextModalFromEl('issueModalFull', 'Issue')"
            aria-label="Open full issue details"
          >
            {{ issue.description or "-" }}
          </button>

          {# Full issue info for modal (cloned into modal on click) #}
          <div id="issueModalFull" hidden>
            {% set code = issue.status.code if issue.status else 'UNKNOWN' %}

            <div class="issue-modal">

              <div class="issue-modal__top">
                <div class="issue-modal__title">{{ issue.title }}</div>

                <span class="chip chip-status status-{{ code|lower|replace('_','-') }}">
                  {{ issue.status.label if issue.status else 'Unknown' }}
                </span>
              </div>

              <div class="issue-modal__meta">
                <div class="meta">
                  <div class="meta__k">Reported by</div>
                  <div class="meta__v">{{ issue.reported_by or "SYSTEM" }}</div>
                </div>

                <div class="meta">
                  <div class="meta__k">Opened</div>
                  {% set _, date = issue.created_at | format_dt %}
                  <div class="meta__v">{{ date }}</div>
                </div>

                <div class="meta">
                  <div class="meta__k">Last update</div>
                  {% set _, date = issue.last_action_at | format_dt %}
                  <div class="meta__v">{{ date }}</div>
                </div>

                <div class="meta">
                  <div class="meta__k">Closed</div>
                  {% if issue.closed_at %}
                    {% set _, date = issue.closed_at | format_dt %}
                    <div class="meta__v">{{ date }}</div>
                  {% else %}
                    <div class="meta__v muted">–</div>
                  {% endif %}
                </div>
              </div>

              <div class="issue-modal__desc">
                <div class="issue-modal__descTitle"><b>Description</b></div>
                <div class="issue-modal__descBody">{{ issue.description or "—" }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="issue-meta">
          <div class="row issue-row">
            <div class="field">
              <label class="issue-label">Reported by</label>
              <div class="pill">{{ issue.reported_by or "SYSTEM" }}</div>
            </div>

            <div class="field">
              <label class="issue-label">Opened</label>
              {% set _, date = issue.created_at | format_dt %}
              <div class="pill"><div class="muted">{{ date }}</div></div>
            </div>
          </div>

          <div class="row issue-row">
            <div class="field">
              <label class="issue-label">Last update</label>
              {% set _, date = issue.last_action_at | format_dt %}
              <div class="pill"><div class="muted">{{ date }}</div></div>
            </div>

            <div class="field">
              <label class="issue-label">Closed</label>
              {% if issue.closed_at %}
                {% set _, date = issue.closed_at | format_dt %}
                <div class="muted">{{ date }}</div>
              {% else %}
                <div class="muted">-</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {# C: robot info (fixed at bottom) #}
      <div class="issue-asset-strip">
        <div class="issue-asset-left">
          <div class="field">
            <label class="issue-label">Tag</label>
            <div class="pill">{{ issue.asset.asset_tag }}</div>
          </div>

          <div class="field">
            <label class="issue-label">Site</label>
            <div class="pill">{{ issue.site_fullname }}</div>
          </div>
        </div>

        <div class="issue-asset-right">
          <div class="mmv">
            {{ issue.asset.make.label }} / {{ issue.asset.model.label }} / {{ issue.asset.variant.label }}
          </div>

          <div class="pill pill-active">
            <a class="asset-link" href="/maintenance/assets/{{ issue.asset.id }}">
              View asset
            </a>
          </div>
        </div>
      </div>
    </div>

    {# ─────────────────────────────
       Photo
       ───────────────────────────── #}
    <div class="card issue-image">
      <h3 class="card-title">Photo (Click to expand)</h3>

      <div class="issue-photo-frame">
        {% if issue.get("has_attachment") %}
          <button
            type="button"
            class="photo-thumb-btn"
            onclick="openImgModal('/maintenance/api/v2/issues/{{ issue.id }}/attachment')"
            aria-label="Open issue photo"
          >
            <img
              class="photo-thumb"
              src="/maintenance/api/v2/issues/{{ issue.id }}/attachment"
              alt="Issue photo"
              loading="lazy"
            />
          </button>
        {% else %}
          <div class="issue-photo-empty">No photo</div>
        {% endif %}
      </div>
    </div>

    {# ─────────────────────────────
       Status Changes
       ───────────────────────────── #}
    <div class="status-col">
      <div class="card status-card status-changes">
        <h3 class="card-title">Status Changes</h3>

        <div class="table table-scroll">
          <div class="table-head table-head--2">
            <div>When</div>
            <div>New Status</div>
          </div>

          {% if issue.status_history %}
            {% for h in issue.status_history %}
              <div class="table-row table-row--2">
                {% set time, date = h.changed_at | format_dt %}
                <div>
                  {{ date }}<br>
                  <span class="time">{{ time }}</span>
                </div>
                <div>{{ h.to_status.label }}</div>
              </div>
            {% endfor %}
          {% else %}
            <div class="table-row table-row--2">
              <div>-</div>
              <div>-</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    {# ─────────────────────────────
       Add update
       ───────────────────────────── #}
    {% if issue.status_code != "CLOSED" %}
      <div class="card update-form update-slot">
        <h3 class="card-title">Add update</h3>

        <form
          method="post"
          action="{{ url_for('app.add_issue_action', issue_id=issue.id) }}"
          class="issue-form issue-form--update"
        >
          <div class="field">
            <label class="issue-label">Action type</label>
            <select name="action_type_code" required>
              {% for at in action_types %}
                {% if at.code != "CREATED" %}
                  <option value="{{ at.code }}">{{ at.label }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="field">
            <label class="issue-label">New status (optional)</label>
            <select name="new_status_id">
              <option value="">(no status change)</option>
              {% for st in status_options %}
                <option value="{{ st.id }}">{{ st.label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="field">
            <label class="issue-label">Created by</label>
            <input
              type="text"
              name="created_by"
              placeholder="Your name or initials (optional)"
            >
          </div>

          <div class="field issue-form-wide">
            <label class="issue-label">Details</label>
            <textarea
              name="body"
              rows="3"
              required
              placeholder="What did you do / what happened?"
            ></textarea>
          </div>

          <div class="issue-form-actions">
            <button type="submit" class="btn btn--ok">Save update</button>
            <a class="btn btn-secondary" href="{{ url_for('app.issues_list') }}">
              Back to list
            </a>
          </div>
        </form>
      </div>
    {% endif %}

    {# ─────────────────────────────
       Activity
       ───────────────────────────── #}
    <div class="card actions-card activity">
      <h3 class="card-title">Activity</h3>

      <div class="table table-scroll">
        <div class="table-head table-head--3">
          <div>When</div>
          <div>Type</div>
          <div>Details</div>
        </div>

        {% if issue.actions %}
          {% for a in issue.actions %}
            <div class="table-row table-row--3">
              {% set time, date = a.created_at | format_dt %}

              <div>
                {{ date }}<br>
                <span class="time">{{ time }}</span>
              </div>

              <div>{{ a.type.label }}</div>

              <div>
                <div class="clamp muted" data-clamp="true">{{ a.body }}</div>
                <button type="button" class="clamp-btn" hidden>Show more</button>
                <div class="muted">by {{ a.created_by.name }}</div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="table-row table-row--3">
            <div>-</div>
            <div>-</div>
            <div>No activity yet.</div>
          </div>
        {% endif %}
      </div>
    </div>

  </div>
{% endblock %}
