{% extends "base.html" %}
{% block title %} Maintenance - Issue {{ issue.get('work_order_id') }} {% endblock %}
{% block page_title %} Maintenance - Issue {{ issue.get('work_order_id') }} {% endblock %}


{% block content %}
  <div class="row" style="gap:16px; align-items:flex-start;">
    <!-- Left: Issue details -->
    <div class="card" style="flex:2;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Issue #{{ issue.get('work_order_id') }}</h2>
        <span class="badge">{{ issue.get('work_order_status') }}</span>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Description</label>
        <div class="pill" style="white-space:pre-wrap;">{{ issue.get('raw_issue_description') }}</div>
      </div>

      <div class="row" style="gap:12px; margin-top:12px;">
        <div class="field" style="flex:1;">
          <label>Opened</label>
          <div class="pill">{{ issue.get('work_order_created_at') }}</div>
        </div>

        {% if issue.get('work_order_status') != 'OPEN' %}
            <div class="field" style="flex:1;">
              <label>Closed</label>
              <div class="pill">{{ issue.get('work_order_closed_at')
                  if issue.get('work_order_closed_at') else "—" }}</div>
            </div>
        {% endif %}
      </div>

        {% if issue.get('work_order_status') != 'OPEN' %}
          <div class="field" style="margin-top:12px;">
            <label>Close note</label>
            <div class="pill" style="white-space:pre-wrap;">{{ issue.get('work_order_close_note')
                if issue.get('work_order_close_note') else "—" }}</div>
          </div>
        {% endif %}
    </div>

    <!-- Right: Asset details -->
    <div class="card" style="flex:1;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Asset</h3>
        <span class="badge">{{ issue.get('asset_status') }}</span>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Tag</label>
        <div class="pill">{{ issue.get('asset_friendly_tag') }}</div>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Make / Model / Variant</label>
        <div class="pill">{{ issue.get('asset_make') }} {{ issue.get('asset_model') }} {{ issue.get('asset_variant') }}</div>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Site</label>
        <div class="pill">{{ issue.get('site_location_shorthand') }}</div>
      </div>

        {% if issue[16] %}
          <div class="row" style="gap:12px; margin-top:12px;">
            <div class="field" style="flex:1;">
              <label>Retired at</label>
              <div class="pill">{{ issue.get('asset_retired_at') if issue.get('asset_retired_at') else "—" }}</div>
            </div>
            <div class="field" style="flex:1;">
              <label>Retired reason</label>
              <div class="pill">{{ issue.get('asset_retired_reason') if issue.get('asset_retired_reason') else "—" }}</div>
            </div>
          </div>
        {% endif %}
    </div>
  </div>

  <!-- Attachments -->
  <div class="card" style="margin-top:16px;">
      <h3 style="margin:0 0 8px 0;">Attachments</h3>

      {% if not issue.get('attachment_storage_path') %}
        <div class="pill">No attachments.</div>
      {% else %}
        {% set att_url = url_for('app.serve_attachment', subpath=issue.get('attachment_storage_path')) %}
        {% if issue.get('attachment_mime_type') and issue.get('attachment_mime_type').startswith('image/') %}
          <a href="{{ att_url }}" target="_blank" rel="noopener">
            <img src="{{ att_url }}" alt="Attachment"
                 style="width:220px; height:160px; object-fit:cover; border-radius:8px;">
          </a>
        {% else %}
          <a class="btn" href="{{ att_url }}" target="_blank" rel="noopener">{{ issue.get('attachment_mime_type') }}</a>
        {% endif %}
      {% endif %}
  </div>

  <!-- Work Log -->
  <div class="table">
      <div class="thead--three">
        <div>Timestamp</div>
        <div>Action Taken</div>
        <div>Result</div>
      </div>


      {% for entry in work_logs %}
        <div class="trow--three">
            <div>{{ entry.get('created_at') }}</div>
            <div>{{ entry.get('action_taken') }}</div>
            <div>{{ entry.get('result') }}</div>
        </div>
      {% else %}
        <div class="trow--three">
            <div>-</div>
            <div>-</div>
            <div>-</div>
        </div>
      {% endfor %}

       <div class="trow--three" id="new-entry-row">
            <div colspan="3" style="text-align:center;">
                <button class="btn btn--brand" id="add-update-btn">+ Update/Resolve Issue</button>
            </div>
        </div>

      <form method="post" action="{{ url_for('app.update_issue', issue_uuid=issue.get('work_order_uuid')) }}">
          <div class="trow--four_three_position" id="update-form-row" style="display:none;">
              <div></div>
              <div>
                  <input type="text" name="action_taken" placeholder="Action Taken" required>
              </div>
              <div>
                  <input type="text" name="result" placeholder="Result" required>
              </div>
              <div>
                  <select name="status">
                      <option value="OPEN">OPEN</option>
                      <option value="IN_PROGRESS">IN PROGRESS</option>
                      <option value="BLOCKED">BLOCKED</option>
                      <option value="CLOSED">CLOSED</option>
                      <!-- TODO: add BLOCKED as an option -->
                  </select>
              </div>
          </div>

          <div class="trow--three" id="submit-row" style="display:none;">
              <div colspan="3" style="text-align:center;">
                  <button type="submit" class="btn btn--ok">Save</button>
              </div>
          </div>
        </form>
  </div>

  <!-- Actions -->
  <div class="row" style="gap:8px; margin-top:16px;">
    <a class="btn btn--brand" href="{{ url_for('app.issues_active') }}">Back to Issues</a>
  </div>


<script>
    document.addEventListener("DOMContentLoaded", function() {
        const addBtn = document.getElementById("add-update-btn");
        const newRow = document.getElementById("new-entry-row");
        const formRow = document.getElementById("update-form-row");
        const submitRow = document.getElementById("submit-row");

        addBtn.addEventListener("click", function(e) {
            e.preventDefault();
            newRow.style.display = "none";   // hide the button row
            formRow.style.display = "grid";  // show the inputs
            submitRow.style.display = "grid"; // show submit
        });
    });
</script>

{% endblock %}
