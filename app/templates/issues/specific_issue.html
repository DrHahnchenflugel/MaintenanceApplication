{% extends "base.html" %}
{% block title %}Maintenance – Issue{% endblock %}
{% block page_title %}Issue{% endblock %}

{% block content %}
  {% if form_error %}
    <div class="card" style="border-left:4px solid #c0392b;margin-bottom:12px;">
      <strong>Error:</strong> {{ form_error }}
    </div>
  {% endif %}

  <div class="issue-layout">
    {# ─────────────────────────────
       Top-left: Issue details
       ───────────────────────────── #}
    <div class="card issue-main">
      <div class="issue-main-header"
           style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <h2 style="margin:0;">{{ issue.title }}</h2>

        {% set code = issue.status.code %}
        <span class="badge badge--{{
              'ok'   if code == 'OPEN'
         else 'warn' if code == 'IN_PROGRESS'
         else 'bad'  if code == 'BLOCKED'
         else 'blue'
        }}">
          {{ issue.status.label }}
        </span>
      </div>

      <div class="issue-main-scroll">
        <div class="field" style="margin-top:12px;">
          <label style="font-weight:bold;">Description</label>
          <div class="pill" style="white-space:pre-wrap;">
            {{ issue.description }}
          </div>
        </div>

        <div class="row" style="gap:12px;margin-top:12px;">
          <div class="field" style="flex:1;">
            <label style="font-weight:bold;">Reported by</label>
            <div class="pill">{{ issue.reported_by or "—" }}</div>
          </div>

          <div class="field" style="flex:1;">
            <label style="font-weight:bold;">Opened</label>
            {% set time, date = issue.created_at | format_dt %}
            <div class="pill">
                <div class="muted">{{ date }}</div>
                {{ time }}
            </div>
          </div>
        </div>

        <div class="row" style="gap:12px;margin-top:12px;">
          <div class="field" style="flex:1;">
            <label style="font-weight:bold;">Last update</label>
            {% set time, date = issue.last_action_at | format_dt %}
            <div class="pill">
                <div class="muted">{{ date }}</div>
                {{ time }}
            </div>
          </div>

          <div class="field" style="flex:1;">
            <label style="font-weight:bold;">Closed</label>
              {% set time, date = issue.closed_at | format_dt %}
            <div class="pill">
                <div class="muted">{{ date }}</div>
                {{ time }}
            </div>
          </div>
        </div>
      </div>
    </div>

    {# ─────────────────────────────
       Top-middle: Photos
       ───────────────────────────── #}
    <div class="card issue-image">
      <h3 style="margin-top:0;">Photos</h3>
      <div class="image-placeholder image-placeholder--large">
        IMAGE GOES HERE
      </div>
    </div>

    {# ─────────────────────────────
       Right column: asset + status + update
       ───────────────────────────── #}
    <div class="right-col">
      {# Asset card at top #}
      <div class="card asset-main">
        <h3 style="margin:0;">Asset</h3>
        <div class="asset-main-body">
          <div class="asset-fields">
            <div class="field">
              <label style="font-weight:bold;">Tag</label>
              <div class="pill">{{ issue.asset.asset_tag }}</div>
            </div>

            <div class="field">
              <label style="font-weight:bold;">Site ID</label>
              <div class="pill">{{ issue.asset.site_id or "—" }}</div>
            </div>
          </div>

          <div class="asset-image">
            <div class="image-placeholder image-placeholder--small">
              GENERIC IMAGE FOR THIS MAKE / MODEL / VARIANT
            </div>
          </div>
        </div>
      </div>

      {# Status card in the middle (flex:1, scrolls) #}
      <div class="card status-card">
        <h3 style="margin-top:0;">Status Changes</h3>

        <div class="table table--scrollable">
          <div class="thead--status">
            <div>When</div>
            <div>New Status</div>
          </div>

          {% if issue.status_history %}
            {% for h in issue.status_history %}
              <div class="trow--status">
                {% set time, date = h.changed_at | format_dt %}
                <div class="status-when">
                    <div class="muted">{{ date }}</div>
                    {{ time }}
                </div>

                <div class="status-what">{{ h.to_status.label }}</div>
              </div>
            {% endfor %}
          {% else %}
            <div class="trow--four">
                <div>-</div>
                <div>-</div>
            </div>
          {% endif %}
        </div>
      </div>

      {# Add update form at bottom of right column #}
      <div class="card update-form">
        <h3 style="margin-top:0;">Add update</h3>

        <form method="post" action="{{ url_for('app.add_issue_action', issue_id=issue.id) }}"
              class="row" style="gap:12px;flex-wrap:wrap;">

          <div class="field" style="flex:1;min-width:180px;">
            <label style="font-weight:bold;">Action type</label>
            <select name="action_type_code" required>
              {% for at in action_types %}
                <option value="{{ at.code }}">{{ at.label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="field" style="flex:1;min-width:180px;">
            <label style="font-weight:bold;">New status (optional)</label>
            <select name="new_status_id">
              <option value="">(no status change)</option>
              {% for st in status_options %}
                <option value="{{ st.id }}">{{ st.label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="field" style="flex:1;min-width:180px;">
            <label style="font-weight:bold;">Created by</label>
            <input type="text" name="created_by" placeholder="Your name or initials">
          </div>

          <div class="field" style="flex-basis:100%;margin-top:12px;">
            <label style="font-weight:bold;">Details</label>
            <textarea name="body" rows="3" required
                      placeholder="What did you do / what happened?"
                      style="width:100%;"></textarea>
          </div>

          <div style="flex-basis:100%;margin-top:8px;">
            <button type="submit" class="btn btn--ok">Save update</button>
            <a class="btn" href="{{ url_for('app.issues_list') }}">Back to list</a>
          </div>
        </form>
      </div>
    </div>

    {# ─────────────────────────────
       Bottom-left: Actions table
       ───────────────────────────── #}
    <div class="card actions-card">
      <h3 style="margin-top:0;">Actions</h3>

      <div class="table table--scrollable">
        <div class="thead--three">
          <div>When</div>
          <div>Type</div>
          <div>Details</div>
        </div>

        {% if issue.actions %}
          {% for a in issue.actions %}
            <div class="trow--three">
              {% set time, date = a.created_at | format_dt %}

              <div class="status-when">
                <div class="muted">{{ date }}</div>
                {{ time }}
              </div>

              <div>{{ a.type.label }}</div>
              <div>
                <div class="status-what;muted;" style="white-space:pre-wrap;">{{ a.body }}</div>
                <div class="muted">by {{ a.created_by.name }}</div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="trow--three">
            <div>-</div><div>-</div><div>No actions yet.</div>
          </div>
        {% endif %}
      </div>
    </div>

  </div> {# end .issue-layout #}

{% endblock %}
