{% extends "base.html" %}
{% block title %} Maintenance - Asset {{ asset.get('asset_friendly_tag') }} {% endblock %}
{% block page_title %} Maintenance - Asset {{ asset.get('asset_friendly_tag') }} {% endblock %}

{% block content %}
    <div class="asset-layout">
        <section class="card asset-asset" style="min-height:10vh">
            <h2 style="margin:0;"> {{ asset.get('asset_friendly_tag') }} </h2>
            <div class="muted"> {{ asset.get('asset_age') }} old </div>
        </section>

        <section class="card asset-asset" style="min-height:10vh">
            <div><h2 style="margin:0;">
                <b>Name: </b>
                <span class="view-only">{{ asset.get('asset_friendly_tag') }}</span>
                <input class="edit-field" type="text" name="asset_friendly_tag"
                       value="{{ asset.get('asset_friendly_tag') }}" style="display:none;" disabled>
            </h2></div>
            <div class="muted">{{ asset.get('asset_age') }} old</div>
        </section>

        <form id="assetForm"
                method="post"
                action="{{ url_for('app.update_asset', asset_uuid=asset.get('asset_uuid')) }}">

            <section class="card asset-meta" id="assetMeta"
                style="min-height:10vh; display:flex; flex-direction:column; justify-content:space-evenly;">

                <div><h4><b>Make: </b>
                    <span class="view-only">{{ asset.get('asset_make') }}</span>
                    <input class="edit-field" type="text" name="asset_make"
                         value="{{ asset.get('asset_make') }}" style="display:none;" disabled>
                </h4></div>

                <div><h4><b>Model: </b>
                    <span class="view-only">{{ asset.get('asset_model') }}</span>
                    <input class="edit-field" type="text" name="asset_model"
                         value="{{ asset.get('asset_model') }}" style="display:none;" disabled>
                </h4></div>

                <div><h4><b>Variant: </b>
                    <span class="view-only">{{ asset.get('asset_variant') }}</span>
                    <input class="edit-field" type="text" name="asset_variant"
                         value="{{ asset.get('asset_variant') }}" style="display:none;" disabled>
                </h4></div>
            </section>
        </form>

        <section class="card card--{{ 'warn' if asset.get('asset_status') == 'IN_MAINTENANCE'
                                        else 'ok' if asset.get('asset_status') == 'ACTIVE'
                                        else 'bad' }}
                                    asset-status" style="min-height:5vh">
            <div><b>Status: </b><span class="badge badge--{{ 'warn' if asset.get('asset_status') == 'IN_MAINTENANCE'
                                        else 'ok' if asset.get('asset_status') == 'ACTIVE'
                                        else 'bad' }}
                                    asset_status" style="min-height:5vh">
                                    {{ asset.get('asset_status') }} </span></div>
            <div class="muted"> - </div>
        </section>


        <section class="card asset-metrics" style="min-height:5vh">
            <div><b>Last Maintenance:</b>
                <div class="muted"> - </div>
            </div>
            <div><b>Uptime:</b>
                <div class="muted"> - </div>
            </div>
        </section>

        <section class="card--nobg column asset-history">
            <h2 style="text-align:center;">Maintenance History</h2>
            <div class="table">
                <div class="thead--four">
                    <div><b>Date</b></div>
                    <div><b>Issue</b></div>
                    <div><b>Length</b></div>
                    <div><b>Result</b></div>
                </div>

                {% for issue in issues %}
                    <a href="{{ url_for('app.view_issue', issue_uuid=issue.get('issue_uuid')) }}" class="trow--four">
                        <div>{{ issue.get('date') }}</div>
                        <div>{{ issue.get('issue') }}</div>
                        <div>{{ issue.get('length') }}</div>
                        <div>{{ issue.get('result') }}</div>
                    </a>
                {% endfor %}

            </div>
        </section>
    </div>
{% endblock %}

{% block footer_center_right %}
    <button type="button" class="btn btn--brand btn--fixed--bottomright btn--lg" id="startEdit">Update</button>

    <div id="editActions" style="display:none; position:fixed; bottom:20px; right:20px; z-index:1000; gap:8px;">
        <button type="submit" form="assetForm" class="btn btn--ok btn--lg">Save</button>
        <button type="button" class="btn btn--bad btn--lg" id="cancelEdit">Cancel</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const startBtn  = document.getElementById('startEdit');
        const cancelBtn = document.getElementById('cancelEdit')

        const actions   = document.getElementById('editActions');;
        const form      = document.getElementById('assetForm');

        const viewEls = document.querySelectorAll('#assetForm .view-only');
        const inputs  = document.querySelectorAll('#assetForm .edit-field');

        const original = new Map(); inputs.forEach(f => original.set(f.name, f.value));

        startBtn?.addEventListener('click', () => {
            startBtn.style.display = 'none';
            actions.style.display = 'flex';
            viewEls.forEach(el => el.style.display = 'none');
            inputs.forEach(f => { f.style.display = 'inline-block'; f.disabled = false; });
            inputs[0]?.focus();
        });

        cancelBtn?.addEventListener('click', () => {
            actions.style.display = 'none';
            startBtn.style.display = 'inline-flex';
            inputs.forEach(f => { f.value = original.get(f.name); f.style.display = 'none'; f.disabled = true; });
            viewEls.forEach(el => el.style.display = 'inline');
        });

        form?.addEventListener('submit', () => {
            inputs.forEach(f => f.disabled = false);
        });
    });
    </script>
{% endblock %}

